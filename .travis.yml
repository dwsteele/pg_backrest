branches:
  only:
    - master
    - integration
    - /-ci$/

dist: trusty
sudo: required

language: c

services:
  - docker

env:
  - PGB_TEST_VM="u16" PGB_BUILD_PARAM="--db=none" PGB_TEST_PARAM="--module=archive --test=unit --test=push-unit --no-lint"

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install libxml-checker-perl libdbd-pg-perl libperl-critic-perl libtemplate-perl libpod-coverage-perl libtest-differences-perl libhtml-parser-perl lintian debhelper txt2man devscripts libjson-perl
  - git clone https://anonscm.debian.org/git/pkg-perl/packages/libdevel-cover-perl.git ~/libdevel-cover-perl
  - cd ~/libdevel-cover-perl && git checkout debian/1.23-2 && debuild -i -us -uc -b
  - sudo dpkg -i ~/libdevel-cover-perl_1.23-2_amd64.deb
  - /usr/bin/cover -v

install:
  - sudo adduser --ingroup=${USER?} --disabled-password --gecos "" backrest
  - umask 0022
  - cd ~ && pwd && whoami && umask && groups
  - mv ${TRAVIS_BUILD_DIR?} pgbackrest
  - rm -rf ${TRAVIS_BUILD_DIR?}
  - pgbackrest/test/test.pl --vm-build --vm=${PGB_TEST_VM?} ${PGB_BUILD_PARAM?}

script:
  - pgbackrest/test/test.pl --vm-host=u14 --vm=${PGB_TEST_VM?} ${PGB_TEST_PARAM?}
